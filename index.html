<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customized City Shipping Portal</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f9; padding: 20px; color: #333; }
        .container { max-width: 950px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-top: 6px solid #0052cc; }
        h2 { color: #0052cc; margin-top: 0; border-bottom: 2px solid #eef2f6; padding-bottom: 15px; font-weight: 700; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 18px; margin-top: 20px; }
        .field { display: flex; flex-direction: column; }
        label { font-size: 11px; font-weight: 700; color: #64748b; margin-bottom: 6px; text-transform: uppercase; }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; outline: none; transition: 0.2s; }
        input:focus { border-color: #0052cc; box-shadow: 0 0 0 3px rgba(0,82,204,0.1); }
        .full { grid-column: span 3; }
        .btn { padding: 14px; cursor: pointer; border-radius: 6px; border: none; font-weight: 600; font-size: 15px; transition: 0.2s; }
        .btn-add { background-color: #0052cc; color: white; margin-top: 20px; width: 100%; }
        .btn-dl { background-color: #1e293b; color: white; margin-top: 30px; width: 100%; }
        .recurring { background: #f8fafc; padding: 20px; border: 1px solid #e2e8f0; border-radius: 8px; margin-top: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 25px; }
        th, td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: left; font-size: 13px; }
        th { background: #f1f5f9; }
        .notion-status { font-size: 11px; font-weight: bold; margin-top: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h2>Customized City Shipping Portal</h2>
    
    <div class="grid">
        <div class="field"><label>Order ID</label><input type="text" id="order_id" placeholder="Paste ID"></div>
        <div class="field"><label>Customer Name</label><input type="text" id="c_name" placeholder="Name"></div>
        <div class="field"><label>Customer Phone</label><input type="text" id="c_phone" maxlength="10"></div>
        <div class="field full"><label>Shipping Address Line 1</label><input type="text" id="addr" placeholder="House, Street, Area"></div>
        <div class="field"><label>Pincode</label><input type="text" id="pin" maxlength="6" oninput="autoCity(this.value)"></div>
        <div class="field"><label>Shipping City</label><input type="text" id="city"></div>
        <div class="field"><label>Shipping State</label><input type="text" id="state"></div>
    </div>

    <h3 style="margin-top:25px; font-size:15px; color:#334155;">Package Details</h3>
    <div class="grid">
        <div class="field">
            <label>Packaging Type</label>
            <select id="p_type">
                <option value="Flyer">Plastic cover/Flyer</option>
                <option value="Box">Corrugated Box</option>
            </select>
        </div>
        <div class="field"><label>Weight (Grams)</label><input type="number" id="w" value="300"></div>
        <div class="field"><label>Length (CM)</label><input type="number" id="l" value="38"></div>
        <div class="field"><label>Breadth (CM)</label><input type="number" id="b" value="33"></div>
        <div class="field"><label>Height (CM)</label><input type="number" id="h" value="3"></div>
    </div>

    <details class="recurring">
        <summary style="cursor:pointer; color:#0052cc; font-weight:bold;">View Connection Settings</summary>
        <div class="grid" style="margin-top:10px;">
            <div class="field"><label>Notion API Key</label><input type="password" id="n_key" placeholder="Paste secret_... here"></div>
            <div class="field"><label>Notion Database ID</label><input type="text" id="n_db" value="2faf3497b13580cb8484ed819149a22a"></div>
            <div class="field"><label>Tax Class Code</label><input type="text" id="tax" value="0"></div>
        </div>
    </details>

    <button class="btn btn-add" onclick="addOrder()">+ Add to Batch & Notion</button>
    <div id="notion-msg" class="notion-status"></div>

    <div id="batchArea" style="display:none;">
        <table id="orderTable">
            <thead><tr><th>Company</th><th>Customer</th><th>City</th><th>Action</th></tr></thead>
            <tbody></tbody>
        </table>
        <button class="btn btn-dl" onclick="downloadCSV()">Generate CSV for Delhivery</button>
    </div>
</div>

<script>
    let batch = [];

    async function autoCity(p) {
        if (p.length === 6) {
            try {
                const res = await fetch(`https://api.postalpincode.in/pincode/${p}`);
                const data = await res.json();
                if (data[0].Status === "Success") {
                    document.getElementById('city').value = data[0].PostOffice[0].District;
                    document.getElementById('state').value = data[0].PostOffice[0].State;
                }
            } catch (e) { console.error("Pincode API error"); }
        }
    }

    async function sendToNotion(order) {
        const apiKey = document.getElementById('n_key').value;
        const dbId = document.getElementById('n_db').value;
        const msg = document.getElementById('notion-msg');

        if(!apiKey) {
            msg.innerText = "⚠ Please paste your API Key in Settings first!";
            msg.style.color = "red";
            return;
        }

        msg.innerText = "Sending to Notion...";
        msg.style.color = "orange";
        const today = new Date().toISOString().split('T')[0];

        const payload = {
            parent: { database_id: dbId },
            properties: {
                "Name": { title: [{ text: { content: order.id } }] },
                "Customer": { rich_text: [{ text: { content: order.n } }] },
                "Phone": { rich_text: [{ text: { content: order.ph } }] },
                "Address": { rich_text: [{ text: { content: order.addr } }] },
                "Pincode": { rich_text: [{ text: { content: order.pin } }] },
                "City": { rich_text: [{ text: { content: order.city } }] },
                "Weight": { rich_text: [{ text: { content: order.w + "g" } }] },
                "Length": { rich_text: [{ text: { content: order.l.toString() } }] },
                "Breadth": { rich_text: [{ text: { content: order.b.toString() } }] },
                "Height": { rich_text: [{ text: { content: order.h.toString() } }] },
                "Upload Date": { date: { start: today } },
                "Status": { select: { name: "Added" } }
            }
        };

        try {
            const response = await fetch(`https://cors-anywhere.herokuapp.com/https://api.notion.com/v1/pages`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'Notion-Version': '2022-06-28'
                },
                body: JSON.stringify(payload)
            });

            if(response.ok) {
                msg.innerText = "✔ Saved to Notion";
                msg.style.color = "green";
            } else {
                msg.innerText = "✖ Notion Error. Ensure the Integration is invited to the page.";
                msg.style.color = "red";
            }
        } catch (e) {
            msg.innerText = "✖ Proxy Blocked. Visit cors-anywhere.herokuapp.com/corsdemo";
            msg.style.color = "red";
        }
    }

    function addOrder() {
        const o = {
            id: document.getElementById('order_id').value,
            n: document.getElementById('c_name').value,
            ph: document.getElementById('c_phone').value,
            pin: document.getElementById('pin').value,
            addr: document.getElementById('addr').value,
            city: document.getElementById('city').value,
            state: document.getElementById('state').value,
            w: document.getElementById('w').value,
            l: document.getElementById('l').value,
            b: document.getElementById('b').value,
            h: document.getElementById('h').value,
            tax: document.getElementById('tax').value,
            ptype: document.getElementById('p_type').value
        };

        if(!o.id || o.pin.length < 6) return alert("Fill Order ID & Pincode");
        
        batch.push(o);
        sendToNotion(o);
        document.getElementById('batchArea').style.display = 'block';
        updateTable();
        ['order_id','c_name','c_phone','pin','addr','city','state'].forEach(el => document.getElementById(el).value = '');
    }

    function updateTable() {
        const tbody = document.querySelector('#orderTable tbody');
        tbody.innerHTML = '';
        batch.forEach((o, i) => {
            tbody.innerHTML += `<tr><td>${o.id}</td><td>${o.n}</td><td>${o.city}</td><td><button onclick="batch.splice(${i},1);updateTable();">X</button></td></tr>`;
        });
    }

    function downloadCSV() {
        let csv = "*Sale Order Number,*Pickup Location Name,*Customer Name,*Customer Phone,*Item Sku Code,*Item Sku Name,*Unit Item Price,Discount Type,Discount Value,Tax Class Code,*Transport Mode,*Payment Mode,*Packaging Type,COD Amount,*Quantity Ordered,Length (cm),Breadth (cm),Height (cm),Weight (gm),Weight (gm),Protect Category Id,Fragile Shipment,Customer Email,*Shipping Address Line1,Shipping Address Line2,*Shipping City,*Shipping State,*Shipping Pincode,Billing Address same as Shipping Address,Billing Address Line1,Billing Address Line2,Billing City,Billing State,Billing Pincode,E-Way Bill Number,Seller Name\n";
        batch.forEach(o => {
            csv += `"${o.id}","Customized City","${o.n}","${o.ph}","4911","Paper Goods","10","","","${o.tax}","Surface","Prepaid","${o.ptype}","0","1","${o.l}","${o.b}","${o.h}","${o.w}","${o.w}","","No","","${o.addr}","","${o.city}","${o.state}","${o.pin}","Yes","","","","","","","CUSTOMIZED CITY"\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `Delhivery_Batch_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
    }
</script>
</body>
</html>